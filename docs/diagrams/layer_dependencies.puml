@startuml layer_dependencies
!theme plain
skinparam linetype ortho
skinparam nodesep 80
skinparam ranksep 100

title 4-Layer Library Architecture\nHexagonal (Ports & Adapters) + Clean + DDD

package "API Layer (Public Facade)" as API #FFEBCD {
  component "api/" as APIFacade
  component "api/desktop" as APIDesktop
  note right of API
    **Public Entry Point**
    - Re-exports domain/application types
    - api/ depends on app + domain ONLY
    - api/desktop wires infrastructure
    - Platform-specific sub-packages
  end note
}

package "Infrastructure Layer" as Infrastructure #E6F3FF {
  component "Adapters" as Adapters
  component "Console Writer" as ConsoleWriter
  note right of Infrastructure
    **Driven Adapters**
    - Implements Output Ports
    - External system integration
    - Depends on Application + Domain
  end note
}

package "Application Layer" as Application #E8F5E9 {
  component "Use Cases" as UseCases
  component "Ports" as Ports
  component "Commands" as Commands
  note right of Application
    **Orchestration Layer**
    - Coordinates domain logic
    - Defines Input/Output Ports
    - DTOs (GreetCommand)
    - **Depends ONLY on Domain**
  end note
}

package "Domain Layer" as Domain #FFF9E6 {
  component "Value Objects" as VOs
  component "domain/error" as DomainError
  component "Result[T]" as Result
  note right of Domain
    **Business Logic Core**
    - Pure domain concepts
    - ZERO external module deps
    - Shareable across apps
  end note
}

' Dependencies - ALL point INWARD (center-seeking)
APIFacade -down-> Application : re-exports types
APIFacade -down-> Domain : re-exports types

' API/desktop can wire everything (composition)
APIDesktop -down-> Infrastructure : wires adapters
APIDesktop -down-> Application : creates use cases
APIDesktop -down-> APIFacade : uses API types

Infrastructure -down-> Application : implements Output Ports
Infrastructure -down-> Domain : uses Value Objects

Application -down-> Domain : orchestrates

' Forbidden dependency (CRITICAL)
APIFacade .right.> Infrastructure #red : ❌ FORBIDDEN\nUse api/desktop

legend right
  **Key Architectural Rules (LIBRARY)**
  ═══════════════════════════════════════
  ✅ **api/ → Application + Domain ONLY**
     (does NOT import Infrastructure)
  ✅ api/desktop → ALL (platform wiring)
  ✅ Infrastructure → Application + Domain
  ✅ Application → Domain

  ❌ **NO** api/ → Infrastructure
     (use api/desktop sub-package instead)
  ❌ **NO** Domain → anything

  **Library vs Application**
  ═══════════════════════════════════════
  • Library: domain, application, infrastructure, api
  • App: domain, application, infrastructure,
         presentation, bootstrap
endlegend

@enduml
